#!/bin/bash
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

if [ "$EUID" != '0' ]; then
	echo 'error: this script must be run as root.'
	exit 1
fi

echo "Please prepare your partition before do this"
echo "[+] Prepare your partition for working env"
echo "[+] Noticeable size is arrounc 10GiB - 20GiB"

fdisk $partition

echo "##############################################################"
echo "[+] Terralinux Pre-Chroot Script"
echo "[+] Setting up Chroot environment..."
echo "[+] this will created a working dir in /mnt"

mkdir -p /mnt/terra-chroot/{etc,dev,proc}

chroot_lock="/mnt/terra-chroot"

echo "[+] Preparing all needed package"

cd $chroot_lock

wget http://archive.terralinux.org/repo/i686/pacman-3.5.2-1-i686.pkg.tar.gz --no-check-certificate
wget http://archive.terralinux.org/repo/i686/libfetch-2.33-3-i686.pkg.tar.gz --no-check-certificate
wget http://archive.terralinux.org/repo/i686/libarchive-2.8.4-2-i686.pkg.tar.gz --no-check-certificate
wget http://archive.terralinux.org/repo/i686/glibc-2.13-5-i686.pkg.tar.xz --no-check-certificate
wget http://archive.terralinux.org/repo/i686/gcc-4.6.0-5-i686.pkg.tar.xz --no-check-certificate
wget http://archive.terralinux.org/repo/i686/gcc-libs-4.6.0-5-i686.pkg.tar.xz --no-check-certificate

for f in *.tar.gz ; do tar xpf $f ; done || return 1
for f in *.tar.xz ; do tar xpf $f ; done || return 1

cp -L /etc/resolv.conf /mnt/terra-chroot/etc/
cp -L /etc/hosts /mnt/terra-chroot/etc/
cp -L /etc/fstab /mnt/terra-chroot/etc/
cp -L /etc/mtab /mnt/terra-chroot/etc/

mount --bind /dev/ /mnt/terra-chroot/dev
mount -t proc /proc /mnt/terra-chroot/proc

echo "##############################################################"
echo "[+] Entering Chroot... "
echo "##############################################################"
echo "[+] Once you have finish, type \"exit\""
echo "##############################################################"

chroot /mnt/terra-chroot

echo "[+] Exited chroot environemnt"

rm -rf /mnt/terra_chroot/etc/mtab
rm -rf /mnt/terra_chroot/etc/fstab

umount /mnt/terra_chroot/dev
umount /mnt/terra_chroot/proc

